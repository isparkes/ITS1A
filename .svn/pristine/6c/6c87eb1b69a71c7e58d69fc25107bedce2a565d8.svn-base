const gulp = require('gulp');
const plumber = require('gulp-plumber');
const htmlmin = require('gulp-htmlmin');
const cleancss = require('gulp-clean-css');
const uglify = require('gulp-uglify');
const gzip = require('gulp-gzip');
const del = require('del');
const useref = require('gulp-useref');
const gulpif = require('gulp-if');
const inline = require('gulp-inline');
const inlineImages = require('gulp-css-inline-images');
const favicon = require('gulp-base64-favicon');

/* Clean destination folder */
gulp.task('clean', function() {
    return del(['data/*']);
});
 
/* Copy static files */
gulp.task('files', function() {
    return gulp.src([
            'web/**/*.{jpg,jpeg,png,ico,gif}',
            'web/fsversion'
        ])
        .pipe(gulp.dest('data/'));
});
 
/* Process HTML, CSS, JS  --- INLINE --- */
gulp.task('inline', function() {
    return gulp.src('web/*.html')
        .pipe(inline({
            base: 'web/',
            js: uglify,
            css: cleancss,
            disabledTypes: ['svg', 'img']
        }))
        .pipe(htmlmin({
            collapseWhitespace: true,
            removeComments: true,
            minifyCSS: true,
            minifyJS: true
        }))
        .pipe(gzip())
        .pipe(gulp.dest('data'));
})
 
gulp.task('buildfs_inline', function() {
    return gulp.src('web/*.html')
        .pipe(inline({
            base: 'web/',
            js: uglify,
            css: [cleancss],
            disabledTypes: ['svg', 'img']
        }))
    	.pipe(inlineImages({
            webRoot: "web"
    	}))
        .pipe(htmlmin({
            collapseWhitespace: true,
            removeComments: true,
            minifyCSS: true,
            minifyJS: true
        }))
        .pipe(gzip())
        .pipe(gulp.dest('data'));
})

/* Process HTML, CSS, JS */
gulp.task('html', function() {
    return gulp.src('web/*.html')
        .pipe(useref())
        .pipe(plumber())
        .pipe(gulpif('*.css', cleancss()))
        .pipe(gulpif('*.js', uglify()))
        .pipe(gulpif('*.html', htmlmin({
            collapseWhitespace: true,
            removeComments: true,
            minifyCSS: true,
            minifyJS: true
        })))
        .pipe(gzip())
        .pipe(gulp.dest('data'));
});
 
/* Build file system */
gulp.task('buildfs', ['clean', 'files', 'html']);
gulp.task('buildfs2', ['clean', 'files', 'inline']);
gulp.task('default', ['buildfs']);
 